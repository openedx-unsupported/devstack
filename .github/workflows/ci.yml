# Core tests: Provision and bring up various services on devstack

name: CI

on:
  push:
    branches: [master]
  pull_request:
    branches:
      - '**'

jobs:

  run_ci:
    runs-on: ${{ matrix.os }}
    env:
      DEVSTACK_WORKSPACE: /tmp
      SHALLOW_CLONE: 1
      # Don't report metrics as real usage
      DEVSTACK_METRICS_TESTING: ci
    strategy:
      matrix:
        # Various service combinations, all on standard OS & Python
        os: [ ubuntu-20.04 ]
        python-version: [ '3.8' ]
        services: [ discovery+lms+forum ,registrar+lms, ecommerce+lms, edx_notes_api+lms, credentials+lms, xqueue]
        include:
          # Try one on Mac too
          - os: macos-10.15
            python-version: '3.8'
            services: discovery+lms+forum
      fail-fast: false # some services can be flaky; let others run to completion even if one fails

    steps:
      - uses: actions/checkout@v2
      - name: setup python
        uses: actions/setup-python@v2
        with:
          python-version: ${{ matrix.python-version }}

      - name: Docker installation - Linux
        if: ${{ startsWith(matrix.os, 'ubuntu-') }}
        run: |
          docker version
          sudo apt-get update
          sudo apt install apt-transport-https ca-certificates curl software-properties-common
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
          sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu focal test"
          sudo apt update
          sudo apt install docker-ce
          docker version
          docker-compose --version
          # free up disk space
          sudo apt remove --purge -y ghc-* azure-cli google-cloud-sdk hhvm llvm-* dotnet-* powershell mono-* php* ruby*

      # Cache boot2docker for speedup and to avoid ratelimiting
      - name: Docker cache - Mac
        if: ${{ startsWith(matrix.os, 'macos-') }}
        uses: actions/cache@v2
        with:
          path: ~/.docker/machine/cache
          key: ${{ runner.os }}-docker-machine

      - name: Docker installation - Mac
        if: ${{ startsWith(matrix.os, 'macos-') }}
        run: |
          brew install docker docker-machine
          docker-machine create --driver virtualbox default
          # See cli-tests.yml for an explanation of this
          docker-machine env default | grep '^export' | sed 's/^export //' | sed 's/"//g' >> $GITHUB_ENV


      - name: set up requirements
        run:  make requirements

      - name: clone
        run:  make dev.clone.https

      - name: pull
        run:  make dev.pull.${{matrix.services}}

      - name: provision
        run:  make dev.provision.${{matrix.services}}

      - name: dev.up
        run:  make dev.up.${{matrix.services}}

      - name: dev.check
        run:  make dev.check.${{matrix.services}}

      - name: docs
        run:  make docs
